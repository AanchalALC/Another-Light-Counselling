{% extends 'skeleton.html' %}
{% load static %}

{% block title %}{{ member.name }}{% if member.pronouns %} ({{ member.pronouns }}){% endif %} | Therapist · Another Light Counselling{% endblock %}
{% block metadescription %}Therapist profile of {{ member.name }} at Another Light Counselling. {{ member.designation }}. {% if member.languages %}Languages: {{ member.languages }}. {% endif %}{% endblock %}
{% block metakeywords %}Another Light Counselling, Therapist, {{ member.name }}, {{ member.designation }}, Counselling, Trauma-informed, Queer-affirmative{% endblock %}

{% block head %}
<link rel="canonical" href="https://www.another-light.com/about/{{ member.slug }}" />
{% endblock %}

{% block body %}
<div id="content">

  <style>
    /* ===== Global sizing guard to avoid overflow ===== */
    *, *::before, *::after{ box-sizing: border-box; }

    /* ===== Brand & layout tokens ===== */
    :root{
      --tangerine:#F08C21;
      --butter:#F2D88F;
      --blush:#E36888;
      --sea:#6698CC;
      --matcha:#B4B534;

      --paper:#FFFCF7;
      --ink:#2d2a2a;
      --muted:#6a6767;
      --ring:rgba(0,0,0,.08);
      --card:#fff;

      --radius:18px;
      --page: min(1120px, 100% - 48px);
      --matcha-700: color-mix(in srgb, var(--matcha), black 18%);

      --photo: 250px;   /* desktop profile pic */
    }

    body{ background:var(--paper); }
    #content{ color:var(--ink); }
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0; }

    /* ===== Page container ===== */
    .page{ width:var(--page); margin-inline:auto; padding:22px 0 40px 0; }
    a.back{ display:inline-flex; align-items:center; gap:8px; margin:6px 0 16px 0; text-decoration:none; color:var(--sea); font-size:14px; }
    a.back:hover{ text-decoration:underline; }

    /* ===== HERO (info left; right = Education + CTAs) ===== */
    .profile-hero{
      display:grid; grid-template-columns: 1.25fr .75fr; gap:28px; align-items:start;
      background: linear-gradient(180deg, color-mix(in srgb, var(--butter) 13%, #fff), #fff 48%, #fff);
      border-radius:16px; padding:18px; border:1px solid var(--ring);
    }
    @media (max-width: 950px){ .profile-hero{ grid-template-columns:1fr; } }

    .info{ display:flex; flex-direction:column; gap:12px; order:1; max-width:100%; }

    /* Top row: big square photo + name right next to it (desktop) */
    .head-row{
      display:grid; grid-template-columns: var(--photo) 1fr; gap:22px; align-items:center; max-width:100%;
    }
    .profile-photo{
      width:var(--photo); aspect-ratio:1/1; border-radius:16px; overflow:hidden;
      border:1px solid var(--ring); background:#eaeaea; flex:none;
    }
    .profile-photo img{ width:100%; height:100%; object-fit:cover; display:block; }

    .name-wrap h1{ margin-left:30px; font-size: clamp(30px, 3.6vw, 40px); line-height:1.1; }
    .name-sub{ margin-left:30px; display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .mini-pill{
      background:#fff; border:1px solid var(--ring);
      padding:6px 10px; border-radius:999px; font-size:12.5px;
      display:inline-flex; align-items:center; gap:6px;
    }
    .mini-pill .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; }
    .mini-pill.pronouns{ background:color-mix(in srgb, var(--blush) 9%, #fff); border-color:color-mix(in srgb, var(--blush), black 10%);}
    .mini-pill.pronouns .dot{ background:var(--blush); }
    .mini-pill.desig{ background:color-mix(in srgb, var(--sea) 9%, #fff); border-color:color-mix(in srgb, var(--sea), black 10%);}
    .mini-pill.desig .dot{ background:var(--sea); }

    /* === Mobile layout changes === */
    @media (max-width: 700px){
      .head-row{ grid-template-columns: 1fr; gap:14px; align-items:start; }
      .name-wrap h1,
      .name-sub{ margin-left:0; }
    }
    @media (max-width: 640px){
      :root{ --photo: 160px; }
      .profile-photo{ border-radius:12px; }
    }
    @media (max-width: 380px){
      :root{ --photo: 170px; }
    }

    /* Meta row under the photo+name (languages) */
    .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{ background:#fff; border:1px solid var(--ring); padding:7px 12px; border-radius:999px; font-size:13px; display:inline-flex; align-items:center; gap:8px; }
    .pill .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .pill.lang{ background:color-mix(in srgb, var(--tangerine) 9%, #fff); border-color:color-mix(in srgb, var(--tangerine), black 10%); }
    .pill.lang .dot{ background:var(--tangerine); }

    /* Availability */
    .availability{ display:inline-flex; align-items:center; gap:8px; margin-top:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid transparent; color:#fff; width:max-content; }
    .availability::before{ content:""; width:8px; height:8px; border-radius:50%; background:currentColor; display:inline-block; opacity:.9; }
    .availability.open{ background:#46b17b; }
    .availability.waitlist{ background:#efc24d; color:#3a2a10; }
    .availability.closed{ background:#e65359; }

    /* Keywords */
    .tags{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; max-width:100%; }
    .tag{ font-size:12px; padding:7px 10px; border-radius:999px; background: color-mix(in srgb, var(--blush) 22%, #fff); border:1px solid color-mix(in srgb, var(--blush), black 10%); color:#3d2030; transition: transform .12s ease, filter .12s ease; }
    .tag:hover{ transform:translateY(-1px); filter:brightness(1.04); }
    .tag.v-tangerine{ background:color-mix(in srgb,var(--tangerine) 20%,#fff); border-color:color-mix(in srgb,var(--tangerine),black 10%); color:#3a2a10; }
    .tag.v-sea{ background:color-mix(in srgb,var(--sea) 18%,#fff); border-color:color-mix(in srgb,var(--sea),black 10%); color:#1f2e45; }
    .tag.v-matcha{ background:color-mix(in srgb,var(--matcha) 24%,#fff); border-color:color-mix(in srgb,var(--matcha),black 10%); color:#2b2a22; }
    .tag.v-butter{ background:color-mix(in srgb,var(--butter) 26%,#fff); border-color:color-mix(in srgb,var(--butter),black 10%); color:#4a3f1a; }
    .tag.v-blush{ background:color-mix(in srgb,var(--blush) 22%,#fff); border-color:color-mix(in srgb,var(--blush),black 10%); color:#3d2030; }

    /* Summary spans the whole left column width */
    .about-brief{
      margin-top:12px; color:#2c2b2b; line-height:1.65;
      background:#fff; border-radius:12px; padding:12px 14px; border:1px solid var(--ring);
      max-width:100%; overflow-wrap:anywhere;
    }

    /* Right column: education + CTAs */
    .media-col{ order:2; display:flex; flex-direction:column; gap:14px; max-width:100%; }

    .video{
      width:100%;
      position:relative;
      aspect-ratio: 16/9;
      background:#000;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--ring);
      margin-top:10px;
    }
    .video iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

    .edu-box{
      background:#fff;
      border:1px solid var(--ring);
      border-radius:12px;
      padding:14px;
      max-width:100%; overflow-wrap:anywhere;
    }
    .edu-box h2{ margin:0 0 10px 0; font-size:20px; }

    /* CTAs stack under education (palette solids with hover) */
    .cta-stack{ display:flex; flex-direction:column; gap:10px; align-items:flex-start; }

    .btn{
      appearance:none; border:1px solid transparent; border-radius:12px;
      padding:12px 16px; font-size:14px; text-decoration:none; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px; color:#fff;
      background-size:120% 120%;
      transition: transform .14s ease, filter .2s ease, box-shadow .2s ease, background-position .32s ease;
      width:90%;
      box-shadow:0 6px 14px rgba(0,0,0,.10);
      align-self:flex-start;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{ background-image: linear-gradient(135deg,var(--matcha),var(--matcha-700)); border-color:color-mix(in srgb,var(--matcha),black 14%); }
    .btn.sea{ background:var(--sea); border-color:color-mix(in srgb,var(--sea),black 12%); }
    .btn.blush{ background:var(--blush); border-color:color-mix(in srgb,var(--blush),black 12%); }
    .btn.tangerine{ background:var(--tangerine); border-color:color-mix(in srgb,var(--tangerine),black 12%); }

    .btn:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow:0 12px 24px rgba(0,0,0,.16);
    }

    /* New: CTA row under long bio */
    .cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:18px;
    }
    .cta-row .btn{
      width:auto;
      align-self:flex-start;
    }

    /* Sections below hero */
    .rule{ height:1px; background:var(--ring); width:100%; margin:24px 0; border:0; }
    .section h2{ margin:0 0 10px 0; font-size:20px; }
    .section .subtle{ color:var(--muted); font-size:13px; margin-top:6px; }

    .longform .rich{ max-width:100%; }
    .longform .rich p{ line-height:1.8; color:#2c2b2b; }

    /* === Mobile-only type & button tweaks === */
    @media (max-width: 640px){
      .about-brief{ font-size:14.5px; line-height:1.7; }
      .edu-box, .edu-box .rich{ font-size:14.5px; }
      .edu-box h2{ font-size:18px; }
      .longform .rich{ font-size:15px; }
      .cta-stack{ align-items:center; }
      .cta-stack .btn{ width:86%; align-self:center; }

      /* For mobile: row CTAs become full-width stacked for tap targets */
      .cta-row{
        flex-direction:column;
        align-items:stretch;
      }
      .cta-row .btn{
        width:100%;
      }
    }
    @media (max-width: 380px){
      .about-brief{ font-size:14px; }
      .longform .rich{ font-size:14.5px; }
      .cta-stack .btn{ width:82%; }
    }

    /* Custom tooltip for Structured Support button */
    .btn.tooltip{
      position:relative;
    }
    .btn.tooltip::after{
      content: attr(data-tooltip);
      position:absolute;
      left:50%;
      top:100%;
      transform:translate(-50%, 8px);
      background:rgba(32,32,32,.96);
      color:#fff;
      font-size:12px;
      line-height:1.4;
      padding:6px 8px;
      border-radius:6px;
      white-space:normal;
      min-width:220px;
      max-width:260px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      z-index:40;
      transition:opacity .15s ease, transform .15s ease;
    }
    .btn.tooltip::before{
      content:"";
      position:absolute;
      left:50%;
      top:100%;
      transform:translate(-50%, 0);
      border-width:6px;
      border-style:solid;
      border-color:transparent transparent rgba(32,32,32,.96) transparent;
      opacity:0;
      z-index:41;
      transition:opacity .15s ease;
    }
    .btn.tooltip:hover::after,
    .btn.tooltip:hover::before{
      opacity:1;
    }

    /* ===== Breadcrumbs (consistent across profile + blogs) ===== */
    .crumbs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:6px 0 16px;
    }
    .crumbs a{
      color:var(--sea);
      text-decoration:none;
      font-size:14px;
    }
    .crumbs a:hover{ text-decoration:underline; }
    .crumbs .sep{ color:var(--muted); }

  </style>

  <div class="page">
    <div class="crumbs">
      <a href="{% url 'about' %}">← Back to All Therapists</a>
      <span class="sep">/</span>
      <span>{{ member.name }}</span>
    </div>

    <!-- HERO -->
    <section class="profile-hero">
      <!-- LEFT: photo + name, then keywords, then VIDEO, then summary -->
      <div class="info">
        <div class="head-row">
          <figure class="profile-photo">
            <img src="{% if member.profile_image %}{{ member.profile_image.url }}{% else %}{{ member.thumbnail.url }}{% endif %}"
                 alt="{{ member.img_alt|default:member.name }}">
          </figure>
          <div class="name-wrap">
            <h1>{{ member.name }}</h1>
            <div class="name-sub">
              {% if member.pronouns %}
                <span class="mini-pill pronouns"><span class="dot"></span>{{ member.pronouns }}</span>
              {% endif %}
              {% if member.designation %}
                <span class="mini-pill desig"><span class="dot"></span>{{ member.designation }}</span>
              {% endif %}
              {% if member.is_therapist %}
                {% if member.availability == 'open' %}
                  <div class="availability open">Currently accepting new clients</div>
                {% elif member.availability == 'waitlist' %}
                  <div class="availability waitlist">Waitlist only</div>
                {% elif member.availability == 'unavailable' %}
                  <div class="availability closed">Not taking clients</div>
                {% endif %}
              {% endif %}
              <div class="meta">
                {% if member.languages %}
                  <span class="pill lang"><span class="dot"></span>Languages: {{ member.languages }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {% if member.keywords.all %}
        <div class="tags" id="profileTags">
          {% for t in member.keywords.all %}
            <span class="tag">{{ t.name }}</span>
          {% endfor %}
        </div>
        {% endif %}

        {% if member.intro_video_url %}
        <div class="video">
          <iframe
            id="videoIframeHero"
            src=""
            title="Intro video"
            loading="eager"
            referrerpolicy="strict-origin-when-cross-origin"
            allow="autoplay; accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
          </iframe>
        </div>
        {% endif %}

        {% with summary=member.info|default_if_none:member.bio_long %}
          <div class="about-brief">
            {{ summary|safe }}
          </div>
        {% endwith %}
      </div>

      <!-- RIGHT: CTAs then Educational background -->
      <div class="media-col">
        <div class="cta-stack">
          {% if member.booking_url %}
          <a class="btn primary" href="{{ member.booking_url }}" target="_blank" rel="noopener">
            Book a Session with {{ member.name }}
          </a>
          {% if member.name == "Aanchal Narang" %}
          <a
            class="btn tangerine"
            href="https://www.another-light.com/aanchal-onboarding-plan"
            target="_blank"
            rel="noopener"
          >
            Aanchal's Onboarding Plans
          </a>
          {% endif %}
          {% endif %}

          {# ✅ Only show blogs CTA for therapists #}
          {% if member.is_therapist %}
            {% url 'member-blog-list' member.slug as internal_blog_url %}

            {% if member.blog_url %}
              <a class="btn sea" href="{{ member.blog_url }}" {% if member.blog_url|slice:":1" != "/" %}target="_blank" rel="noopener"{% endif %}>
                Read My Blogs
              </a>
            {% else %}
              <a class="btn sea" href="{{ internal_blog_url }}">Read My Blogs</a>
            {% endif %}
          {% endif %}

          {% if member.media_url %}
          <a class="btn blush" href="{{ member.media_url }}" target="_blank" rel="noopener">Know My Journey</a>
          {% endif %}

          {# Extra CTAs only for Aanchal Narang #}
          {% if member.name == "Aanchal Narang" %}
          <a
            class="btn tangerine tooltip"
            href="https://www.another-light.com/"
            target="_blank"
            rel="noopener"
            data-tooltip="Looking for Aanchal's structured signature plans? Click here to view and book."
          >
            Structured Support from Aanchal
          </a>
          {% endif %}
        </div>

        {% if member.certifications %}
          <div class="edu-box">
            <div class="rich">{{ member.certifications|safe }}</div>
          </div>
        {% endif %}
      </div>
    </section>

    <hr class="rule">
    <section class="section longform">
      <h2>Full Biography</h2>
      <div class="rich">
        {% if member.bio_long %}{{ member.bio_long|safe }}{% else %}{{ member.info|safe }}{% endif %}
      </div>

      <!-- Same CTAs again, now as a row under the long bio -->
      <div class="cta-row">
        {% if member.booking_url %}
        <a class="btn primary" href="{{ member.booking_url }}" target="_blank" rel="noopener">
          Book a Session with {{ member.name }}
        </a>
        {% if member.name == "Aanchal Narang" %}
        <a
          class="btn tangerine"
          href="https://www.another-light.com/aanchal-onboarding-plan"
          target="_blank"
          rel="noopener"
        >
          Aanchal's Onboarding Plans
        </a>
        {% endif %}
        {% endif %}

        {# ✅ Only show blogs CTA for therapists #}
        {% if member.is_therapist %}
          {% url 'member-blog-list' member.slug as internal_blog_url %}

          {% if member.blog_url %}
            <a class="btn sea" href="{{ member.blog_url }}" {% if member.blog_url|slice:":1" != "/" %}target="_blank" rel="noopener"{% endif %}>
              Read My Blogs
            </a>
          {% else %}
            <a class="btn sea" href="{{ internal_blog_url }}">Read My Blogs</a>
          {% endif %}
        {% endif %}

        {% if member.media_url %}
        <a class="btn blush" href="{{ member.media_url }}" target="_blank" rel="noopener">Know My Journey</a>
        {% endif %}

        {% if member.name == "Aanchal Narang" %}
        <a
          class="btn tangerine tooltip"
          href="https://www.another-light.com/"
          target="_blank"
          rel="noopener"
          data-tooltip="Looking for Aanchal's structured signature plans? Click here to view and book."
        >
          Structured Support from Aanchal
        </a>
        {% endif %}
      </div>
    </section>
  </div>

  <script>
    // Randomize keyword chip colors on the profile
    (function(){
      const palette = ['tangerine','sea','matcha','butter','blush'];
      const rows = document.getElementById('profileTags');
      if(rows){
        rows.querySelectorAll('.tag').forEach(tag=>{
          const cls = 'v-' + palette[Math.floor(Math.random()*palette.length)];
          tag.classList.add(cls);
        });
      }
    })();

    // Build a safe embed URL (YouTube/Vimeo) with autoplay + mute (for policy) and fallback
    (function(){
      const frame = document.getElementById('videoIframeHero');
      if(!frame) return;

      const raw = `{{ member.intro_video_url|default_if_none:''|escapejs }}`.trim();
      const FALLBACK = 'https://www.youtube.com/embed/7LD8iC4NqXM?si=y04ImxvQ0rjrAHsu';

      function ytEmbed(u){
        if (u.hostname.includes('youtu.be')) {
          const id = u.pathname.replace(/^\/+/, '').split('/')[0];
          return id ? `https://www.youtube.com/embed/${id}` : '';
        }
        if (u.hostname.includes('youtube.com')) {
          if (u.pathname.startsWith('/embed/')) return `https://www.youtube.com${u.pathname}`;
          if (u.pathname.startsWith('/shorts/')) {
            const id = u.pathname.split('/')[2] || '';
            return id ? `https://www.youtube.com/embed/${id}` : '';
          }
          const v = u.searchParams.get('v');
          if (v) return `https://www.youtube.com/embed/${v}`;
        }
        return '';
      }

      function vimeoEmbed(u){
        if (!u.hostname.includes('vimeo.com')) return '';
        const parts = u.pathname.split('/').filter(Boolean);
        const id = (parts[0]==='video' ? parts[1] : parts[0]) || '';
        return id ? `https://player.vimeo.com/video/${id}` : '';
      }

      function withAutoplayParams(urlStr){
        try{
          const u = new URL(urlStr);
          u.searchParams.set('autoplay','1');
          u.searchParams.set('mute','1');
          u.searchParams.set('rel','0');
          u.searchParams.set('modestbranding','1');
          u.searchParams.set('playsinline','1');
          return u.toString();
        }catch(e){ return urlStr; }
      }

      let embed = '';
      if(raw){
        try{
          const parsed = new URL(raw, window.location.origin);
          embed = ytEmbed(parsed) || vimeoEmbed(parsed) || '';
        }catch(e){}
      }
      if(!embed) embed = FALLBACK;

      frame.src = withAutoplayParams(embed);
    })();
  </script>

</div>
{% endblock %}
